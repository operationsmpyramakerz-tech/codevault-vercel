<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Storage - Assigned Orders</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="app-container">
    <header class="topbar">
      <h1>Storage</h1>
    </header>

    <!-- Filter Tabs -->
    <div class="stats-nav">
      <button id="st-btn-total" class="nav-btn" data-filter="all">Total assigned</button>
      <button id="st-btn-full" class="nav-btn" data-filter="full">Fully available</button>
      <button id="st-btn-missing" class="nav-btn" data-filter="missing">Missing</button>
    </div>

    <main class="content">
      <div id="orders-list"></div>
    </main>
  </div>

  <script src="/js/common-ui.js"></script>
  <script src="/js/assigned-orders.js"></script>

<script>
(function() {
  function qs(sel, ctx){ return (ctx||document).querySelector(sel); }
  function qsa(sel, ctx){ return Array.from((ctx||document).querySelectorAll(sel)); }

  function normalizeLabel(txt) {
    if(!txt) return "";
    txt = txt.trim().toLowerCase();
    // Arabic/English variations we expect on the storage page
    if (txt.includes('fully')) return 'fully';
    if (txt.includes('available')) return 'fully';
    if (txt.includes('missing') || txt.includes('غير متاح') || txt.includes('not prepared')) return 'missing';
    if (txt.includes('total')) return 'total';
    if (txt.includes('assigned')) return 'total';
    return txt;
  }

  function findStatCards(){
    // Try to detect the 3 stat cells by their labels inside
    const container = document.body;
    if(!container) return [];
    const candidates = qsa('.stat, .stat-card, .panel-stat, .card, .info-card, [data-stat]', container);
    const stats = [];
    candidates.forEach(card => {
      const labelEl = card.querySelector('.label, .stat-label, .title, .name, .heading, .stat-title, small, span, h6, h5');
      const text = (labelEl ? labelEl.textContent : card.textContent) || '';
      const kind = normalizeLabel(text);
      if (kind === 'total' || kind === 'fully' || kind === 'missing') {
        stats.push({el: card, kind});
      }
    });
    // Fallback: look for elements that literally contain labels
    if (stats.length < 3) {
      qsa('*').forEach(node => {
        const t = (node.textContent||'').trim().toLowerCase();
        if (t === 'total assigned' || t === 'fully available' || t === 'missing') {
          const card = node.closest('.card, .stat, .panel, .panel-stat, .box, .info-card, .stat-card') || node.parentElement;
          if (card) {
            stats.push({el: card, kind: normalizeLabel(t)});
          }
        }
      });
    }
    return stats;
  }

  function setActive(kind){
    const stats = findStatCards();
    stats.forEach(s => {
      s.el.classList.remove('active');
      s.el.setAttribute('aria-pressed', 'false');
      s.el.setAttribute('role', 'button');
      s.el.classList.add('stat--btn');
    });
    const target = stats.find(s => s.kind === kind);
    if (target) {
      target.el.classList.add('active');
      target.el.setAttribute('aria-pressed', 'true');
    }
  }

  function getTabFromQuery(){
    const p = new URLSearchParams(location.search);
    const tab = (p.get('tab')||'').toLowerCase();
    if (tab.includes('fully')) return 'fully';
    if (tab.includes('missing')) return 'missing';
    if (tab.includes('total')) return 'total';
    // storage default shows all; highlight total
    return 'total';
  }

  function wireClicks(){
    const stats = findStatCards();
    stats.forEach(s => {
      s.el.setAttribute('role','button');
      s.el.classList.add('stat--btn');
      s.el.addEventListener('click', () => {
        // update query param to keep behavior compatible with your router/filter
        const url = new URL(location.href);
        url.searchParams.set('tab',
          s.kind === 'fully' ? 'FullyAvailable' :
          s.kind === 'missing' ? 'Missing' : 'Total'
        );
        location.href = url.toString();
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    setActive(getTabFromQuery());
    wireClicks();
  });
})();
</script>

</body>
</html>